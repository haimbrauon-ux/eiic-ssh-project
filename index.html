<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EIIC SSH Project Manager</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { background: white; min-height: 100vh; }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 15px;
      text-align: center;
    }
    .header h1 { font-size: 1.3em; margin-bottom: 5px; }
    .header p { font-size: 0.85em; opacity: 0.9; }
    .header .admin-controls { margin-top: 10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }

    .tabs {
      display:flex;
      background:#f8f9fa;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border-bottom: 2px solid #e9ecef;
    }
    .tabs::-webkit-scrollbar { display:none; }
    .tab {
      padding: 15px 20px;
      border:none;
      background: transparent;
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      white-space: nowrap;
      flex-shrink: 0;
      cursor: pointer;
      position: relative;
    }
    .tab.active { color:#667eea; background:white; }
    .tab.active::after {
      content:'';
      position:absolute;
      bottom:-2px; left:0; right:0;
      height:2px;
      background:#667eea;
    }

    .tab-content { display:none; padding:15px; }
    .tab-content.active { display:block; }

    .card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white;
      padding:20px;
      border-radius:10px;
      margin-bottom:15px;
    }
    .card h3 { font-size:0.85em; opacity:0.9; margin-bottom:8px; }
    .card .value { font-size:2em; font-weight:bold; margin-bottom:5px; }
    .card .label { font-size:0.8em; opacity:0.8; }

    h2 { color:#2d3748; margin:20px 0 15px 0; font-size:1.2em; }

    .budget-input-section {
      background:#f8f9fa;
      padding:20px;
      border-radius:10px;
      margin-bottom:20px;
    }
    .budget-input-section label {
      display:block;
      font-weight:600;
      margin-bottom:5px;
      color:#2d3748;
    }
    .budget-input-section input {
      width:100%;
      padding:10px;
      border:2px solid #e9ecef;
      border-radius:5px;
      font-size:16px;
      margin-bottom:15px;
    }

    .quarterly-prediction {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:10px;
      margin-bottom:20px;
    }
    .quarter-card {
      background:white;
      padding:15px;
      border-radius:8px;
      border:2px solid #e9ecef;
      text-align:center;
    }
    .quarter-card h4 { font-size:0.9em; color:#667eea; margin-bottom:10px; }
    .quarter-card .prediction { font-size:1.2em; font-weight:bold; padding:5px 10px; border-radius:5px; display:inline-block; }
    .quarter-card .prediction.overspending { background:#f8d7da; color:#721c24; }
    .quarter-card .prediction.underspending { background:#fff3cd; color:#856404; }
    .quarter-card .prediction.on-budget { background:#d4edda; color:#155724; }
    .quarter-card .prediction.future { background:#e7f3ff; color:#004085; }

    .table-wrapper {
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      margin-bottom:20px;
      border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      width:100%;
      border-collapse:collapse;
      background:white;
      min-width:600px;
    }
    th, td {
      padding:10px 8px;
      text-align:left;
      border-bottom:1px solid #e9ecef;
      font-size:0.85em;
    }
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white;
      font-weight:600;
      text-transform:uppercase;
      font-size:0.75em;
      position:sticky;
      top:0;
    }
    tr:hover { background:#f8f9fa; }
    tr.overdue { background:#ffe6e6 !important; }
    tr.done { background:#d4edda !important; }
    tr.menu-done { background:#e8f5e9 !important; }

    .status {
      padding:4px 8px;
      border-radius:12px;
      font-size:0.75em;
      font-weight:600;
      display:inline-block;
      white-space:nowrap;
    }
    .status.done { background:#d4edda; color:#155724; }
    .status.ongoing { background:#fff3cd; color:#856404; }
    .status.assigned { background:#d1ecf1; color:#0c5460; }
    .status.not-assigned { background:#f8d7da; color:#721c24; }
    .status.delayed { background:#f8d7da; color:#721c24; }
    .status.planned { background:#e2e3e5; color:#383d41; }
    .status.ordered { background:#d1ecf1; color:#0c5460; }
    .status.pending { background:#fff3cd; color:#856404; }
    .status.received { background:#d4edda; color:#155724; }
    .status.po-sent { background:#d1ecf1; color:#0c5460; }
    .status.complete { background:#d4edda; color:#155724; }

    .flag {
      padding:3px 6px;
      border-radius:8px;
      font-size:0.7em;
      font-weight:600;
      display:inline-block;
      margin-left:5px;
    }
    .flag.delayed { background:#dc3545; color:white; }
    .flag.done { background:#28a745; color:white; }
    .flag.overdue { background:#dc3545; color:white; }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white;
      padding:10px 20px;
      border:none;
      border-radius:5px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      margin:5px 0;
    }
    .btn-small { padding:6px 12px; font-size:0.8em; margin:2px; }
    .btn-secondary { background:#6c757d; }
    .btn-danger { background:#dc3545; }
    .btn-edit { background:#28a745; }
    .btn-flag { background:#ffc107; color:#000; }

    .search-box {
      width:100%;
      padding:12px;
      border:2px solid #e9ecef;
      border-radius:5px;
      font-size:16px;
      margin-bottom:15px;
    }

    .filter-group { display:flex; flex-direction:column; gap:10px; margin-bottom:15px; }
    .filter-row { display:flex; gap:10px; flex-wrap:wrap; }
    .filter-row select, .filter-row input {
      flex:1;
      min-width:150px;
      padding:8px;
      border:2px solid #e9ecef;
      border-radius:5px;
      font-size:14px;
    }

    .modal {
      display:none;
      position:fixed;
      z-index:1000;
      left:0; top:0;
      width:100%; height:100%;
      overflow:auto;
      background-color:rgba(0,0,0,0.4);
    }
    .modal.active { display:block; }
    .modal-content {
      background-color:white;
      margin:5% auto;
      padding:20px;
      border-radius:10px;
      width:90%;
      max-width:500px;
      max-height:80vh;
      overflow-y:auto;
    }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .modal-header h2 { margin:0; }
    .close { color:#aaa; font-size:28px; font-weight:bold; cursor:pointer; }
    .close:hover { color:#000; }

    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; color:#2d3748; }
    .form-group input, .form-group select, .form-group textarea {
      width:100%;
      padding:10px;
      border:2px solid #e9ecef;
      border-radius:5px;
      font-size:14px;
    }
    .form-group textarea { min-height:80px; resize:vertical; }

    .editable-cell { cursor:pointer; position:relative; }
    .editable-cell:hover { background:#f0f0f0; }
    .editable-cell input { width:100%; padding:5px; border:2px solid #667eea; border-radius:3px; font-size:0.85em; }

    .validation-error { color:#dc3545; font-size:0.85em; margin-top:10px; padding:10px; background:#f8d7da; border-radius:5px; }
    .validation-success { color:#155724; font-size:0.85em; margin-top:10px; padding:10px; background:#d4edda; border-radius:5px; }

    /* Small header status contrast */
    #syncStatus { color: #ffffff; opacity: 0.95; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ EIIC SSH Project Manager</h1>
      <p>2026 Action Items &amp; Budget Tracker</p>
      <div id="syncStatus"></div>

      <div class="admin-controls">
        <button class="btn-small btn-secondary" type="button" onclick="adminUnlock()">üîì Admin</button>
        <button class="btn-small btn-secondary" type="button" onclick="lockAdmin()">üîí Lock admin tabs</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('menu', event)">Menu Tasks</button>
      <button class="tab" onclick="switchTab('orders', event)">PO Tracker</button>
      <button class="tab" onclick="switchTab('flights', event)">Flights</button>
      <button class="tab" onclick="switchTab('tasks', event)">Bank</button>
      <button class="tab" onclick="switchTab('budget', event)">Budget</button>
      <button class="tab" onclick="switchTab('data', event)">Data</button>
    </div>

    <!-- Menu Tasks -->
    <div id="menu" class="tab-content active">
      <h2>üìã Priority Menu Tasks (Assigned Only)</h2>
      <div class="filter-group">
        <div class="filter-row">
          <select id="menuOwnerFilter" onchange="filterMenuTasks()">
            <option value="">All Owners</option>
          </select>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Project Name</th><th>Task</th><th>Owner</th><th>Due Date</th><th>Priority</th>
              <th>Status</th><th>Status Update</th><th>Notes</th><th>Deliverable Links</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="menuTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Bank -->
    <div id="tasks" class="tab-content">
      <div class="card">
        <h3>Total Tasks in Bank</h3>
        <div class="value" id="taskCount">0</div>
        <div class="label">Action Items</div>
      </div>

      <button type="button" onclick="openTaskModal()">‚ûï Add New Task</button>
      <input type="text" class="search-box" id="taskSearch" placeholder="Search tasks..." onkeyup="filterTasks()" />

      <div class="filter-group">
        <div class="filter-row">
          <select id="taskOwnerFilter" onchange="filterTasks()">
            <option value="">All Owners</option>
          </select>
          <select id="taskStatusFilter" onchange="filterTasks()">
            <option value="">All Status</option>
            <option value="Done">Done</option>
            <option value="Assigned">Assigned</option>
            <option value="Not Assigned">Not Assigned</option>
            <option value="Delayed">Delayed</option>
          </select>
        </div>
      </div>

      <h2>Task Bank</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Project Name</th><th>Owner</th><th>Due Date</th><th>Task</th><th>Priority</th>
              <th>Status</th><th>Menu Status</th><th>Notes</th><th>Deliverable Links</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="taskTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Orders -->
    <div id="orders" class="tab-content">
      <button type="button" onclick="openOrderModal()">‚ûï Add New Order</button>
      <h2>Purchase Orders</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Date</th><th>Sub Project</th><th>Vendor</th><th>Cost</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="ordersTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Flights -->
    <div id="flights" class="tab-content">
      <button type="button" onclick="openFlightModal()">‚ûï Add New Flight</button>
      <h2>Flight Schedule</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Dates</th><th>Destination</th><th>Travelers</th><th>Cost (USD)</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="flightsTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Budget -->
    <div id="budget" class="tab-content">
      <div class="budget-input-section">
        <label for="totalBudgetInput">Total Annual Budget (USD)</label>
        <input type="number" id="totalBudgetInput" value="60000" onchange="updateBudgetSummary()">

        <label for="flightBudgetAllocation">Flight Budget Allocation (USD)</label>
        <input type="number" id="flightBudgetAllocation" value="20000" onchange="updateBudgetSummary()">

        <div id="budgetValidation"></div>
      </div>

      <div class="card">
        <h3>Operational Budget</h3>
        <div class="value" id="operationalBudget">$40,000</div>
        <div class="label">Total Budget - Flight Allocation</div>
      </div>

      <h2>üìä Quarterly Spending Predictions</h2>
      <div class="quarterly-prediction" id="quarterlyPredictions"></div>

      <h2>üí∞ Budget Summary</h2>
      <div class="table-wrapper">
        <table style="min-width: 400px;">
          <tr><td><strong>Operational Budget:</strong></td><td id="operationalBudget2">$40,000</td></tr>
          <tr><td><strong>Spent from POs:</strong></td><td id="spentFromPOs">$0</td></tr>
          <tr><td><strong>Spent from Flights:</strong></td><td id="spentFromFlights">$0</td></tr>
          <tr><td><strong>Subtotal Spent:</strong></td><td id="subtotalSpent">$0</td></tr>
          <tr style="background:#f8f9fa;font-weight:bold;"><td><strong>Total Remaining:</strong></td><td id="totalRemaining">$60,000</td></tr>
          <tr><td><strong>Operational Remaining:</strong></td><td id="operationalRemaining">$40,000</td></tr>
          <tr><td><strong>Flight Remaining:</strong></td><td id="flightRemaining">$20,000</td></tr>
        </table>
      </div>

      <h2>üìë Detailed Budget Breakdown</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Code</th><th>Sub Project Name</th>
              <th>Q1 AOP</th><th>Q1 ACT</th>
              <th>Q2 AOP</th><th>Q2 ACT</th>
              <th>Q3 AOP</th><th>Q3 ACT</th>
              <th>Q4 AOP</th><th>Q4 ACT</th>
              <th>Total AOP</th><th>Total ACT</th>
            </tr>
          </thead>
          <tbody id="budgetTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Data -->
    <div id="data" class="tab-content">
      <h2>‚öôÔ∏è System Configuration</h2>

      <!-- Optional: local password setter (not required to unlock) -->
      <div class="budget-input-section">
        <h3>üîí Soft Admin Password (optional)</h3>
        <div class="form-group">
          <label>Set Admin Password (stored only on this browser)</label>
          <input type="password" id="systemPassword" placeholder="Type and leave the field to save locally">
          <small>Soft security only. This updates the password stored in your browser (localStorage).</small>
        </div>
      </div>

      <div class="budget-input-section">
        <h3>üí± Exchange Rates</h3>
        <div class="form-group">
          <label>ILS to USD Conversion Rate</label>
          <input type="number" step="0.01" id="ilsToUsdRate" value="3.25">
          <small>1 USD = X ILS</small>
        </div>
        <div class="form-group">
          <label>EUR to USD Conversion Rate</label>
          <input type="number" step="0.01" id="eurToUsdRate" value="0.92">
          <small>1 USD = X EUR</small>
        </div>
      </div>

      <div class="budget-input-section">
        <h3>üìß Email Template for Task Assignments</h3>
        <div class="form-group">
          <label>Email Subject</label>
          <input type="text" id="emailSubject" value="Your Assigned Tasks - EIIC SSH Project">
        </div>
        <div class="form-group">
          <label>Email Message Template</label>
          <textarea id="emailTemplate" rows="8" style="width:100%;padding:10px;border:2px solid #e9ecef;border-radius:5px;">Hi {name},

Here are your currently assigned tasks for the EIIC SSH Project:

{tasks}

Please review and update your progress accordingly.

Best regards,
EIIC SSH Project Team</textarea>
        </div>
        <div style="display:flex;gap:10px;align-items:center;margin-top:15px;">
          <button type="button" onclick="sendAllEmails()" class="btn-edit">üìß Send All Emails</button>
          <select id="emailRecipientSelect" style="flex:1;padding:10px;border:2px solid #e9ecef;border-radius:5px;">
            <option value="">Select team member...</option>
          </select>
          <button type="button" onclick="sendEmailByOwner()" class="btn-secondary">üìß Send to One Person</button>
        </div>
      </div>

      <h2>üë• Team Members</h2>
      <button type="button" onclick="openTeamMemberModal()">‚ûï Add Team Member</button>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Actions</th></tr></thead>
          <tbody id="teamMembersTableBody"></tbody>
        </table>
      </div>

      <h2>üì¶ Project Names (for Tasks)</h2>
      <button type="button" onclick="openProjectModal()">‚ûï Add Project</button>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Project Name</th><th>Actions</th></tr></thead>
          <tbody id="projectNamesTableBody"></tbody>
        </table>
      </div>

      <h2>üíº Sub Project Names (for Budget)</h2>
      <button type="button" onclick="openSubProjectModal()">‚ûï Add Sub Project</button>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Code</th><th>Sub Project Name</th><th>Actions</th></tr></thead>
          <tbody id="subProjectNamesTableBody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /container -->

  <!-- ===================== MODALS ===================== -->

  <!-- Order Modal -->
  <div id="orderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="orderModalTitle">Add New Order</h2>
        <span class="close" onclick="closeOrderModal()">√ó</span>
      </div>
      <form onsubmit="saveOrder(event)">
        <div class="form-group"><label>Order Date</label><input type="date" id="orderDate" required></div>
        <div class="form-group"><label>Sub Project</label><select id="orderProject" required></select></div>
        <div class="form-group"><label>Vendor</label><input type="text" id="orderVendor" required></div>
        <div class="form-group">
          <label>Currency</label>
          <select id="orderCurrency" onchange="updateCurrencyLabel()">
            <option value="ILS">ILS (‚Ç™)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (‚Ç¨)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Cost (<span id="currencyLabel">ILS</span>)</label>
          <input type="number" step="0.01" id="orderCost" required oninput="showUSDConversion()">
          <small id="usdConversion" style="color:#667eea;"></small>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="orderStatus" required>
            <option value="Planned">Planned</option>
            <option value="Ordered">Ordered</option>
            <option value="PO Sent">PO Sent</option>
            <option value="Received">Received</option>
          </select>
        </div>
        <button type="submit">Save Order</button>
        <button type="button" class="btn-secondary" onclick="closeOrderModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Flight Modal -->
  <div id="flightModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="flightModalTitle">Add New Flight</h2>
        <span class="close" onclick="closeFlightModal()">√ó</span>
      </div>
      <form onsubmit="saveFlight(event)">
        <div class="form-group"><label>Start Date</label><input type="date" id="flightStartDate" required></div>
        <div class="form-group"><label>End Date</label><input type="date" id="flightEndDate" required></div>
        <div class="form-group"><label>Destination</label><input type="text" id="flightDestination" required></div>
        <div class="form-group">
          <label>Travelers</label>
          <select id="flightTravelers" required multiple size="8">
            <option value="Haim">Haim</option>
            <option value="Gal">Gal</option>
            <option value="Hadas">Hadas</option>
            <option value="Amir">Amir</option>
            <option value="Nofar">Nofar</option>
            <option value="Shiri">Shiri</option>
            <option value="Tom">Tom</option>
            <option value="Tal">Tal</option>
          </select>
          <small>Hold Ctrl/Cmd to select multiple travelers</small>
        </div>
        <div class="form-group"><label>Cost (USD)</label><input type="number" step="0.01" id="flightCost"><small>Leave empty for TBD</small></div>
        <div class="form-group">
          <label>Status</label>
          <select id="flightStatus" required>
            <option value="Planned">Planned</option>
            <option value="Ordered">Ordered</option>
            <option value="Complete">Complete</option>
          </select>
        </div>
        <button type="submit">Save Flight</button>
        <button type="button" class="btn-secondary" onclick="closeFlightModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Task Update Modal -->
  <div id="taskUpdateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Update Task Status</h2>
        <span class="close" onclick="closeTaskUpdateModal()">√ó</span>
      </div>
      <form onsubmit="saveTaskUpdate(event)">
        <div class="form-group">
          <label>Status Update</label>
          <select id="taskUpdateStatus" required>
            <option value="">Select Status</option>
            <option value="Done">Done</option>
            <option value="Delayed">Delayed</option>
            <option value="Ongoing">Ongoing</option>
          </select>
        </div>
        <div class="form-group"><label>Deliverable Link</label><input type="text" id="taskUpdateDeliverables" placeholder="https://..."></div>
        <div class="form-group"><label>Notes (Optional)</label><textarea id="taskUpdateNotes"></textarea></div>
        <button type="submit">Save Update</button>
        <button type="button" class="btn-secondary" onclick="closeTaskUpdateModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Task Modal -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="taskModalTitle">Add New Task</h2>
        <span class="close" onclick="closeTaskModal()">√ó</span>
      </div>
      <form onsubmit="saveTask(event)">
        <div class="form-group"><label>Project Name</label><select id="taskProjectName" required><option value="">Select Project...</option></select></div>
        <div class="form-group">
          <label>Owner</label>
          <select id="taskOwner" required></select>
        </div>
        <div class="form-group"><label>Due Date</label><input type="date" id="taskDueDate"></div>
        <div class="form-group"><label>Task Description</label><textarea id="taskDescription" required></textarea></div>
        <div class="form-group">
          <label>Priority</label>
          <select id="taskPriority" required>
            <option value="High">High</option>
            <option value="Mid-High">Mid-High</option>
            <option value="Mid">Mid</option>
            <option value="Low-Mid">Low-Mid</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="taskStatus" required>
            <option value="Not Assigned">Not Assigned</option>
            <option value="Assigned">Assigned</option>
            <option value="Done">Done</option>
            <option value="Delayed">Delayed</option>
            <option value="Ongoing">Ongoing</option>
          </select>
        </div>
        <div class="form-group"><label>Notes</label><textarea id="taskNotes"></textarea></div>
        <div class="form-group"><label>Deliverable Links</label><input type="text" id="taskDeliverables" placeholder="https://..."></div>
        <button type="submit">Save Task</button>
        <button type="button" class="btn-secondary" onclick="closeTaskModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Team Member Modal -->
  <div id="teamMemberModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="teamMemberModalTitle">Add Team Member</h2>
        <span class="close" onclick="closeTeamMemberModal()">√ó</span>
      </div>
      <form onsubmit="saveTeamMember(event)">
        <div class="form-group"><label>Name</label><input type="text" id="teamMemberName" required></div>
        <div class="form-group"><label>Email</label><input type="email" id="teamMemberEmail" required></div>
        <button type="submit">Save Team Member</button>
        <button type="button" class="btn-secondary" onclick="closeTeamMemberModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Project Modal -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="projectModalTitle">Add Project</h2>
        <span class="close" onclick="closeProjectModal()">√ó</span>
      </div>
      <form onsubmit="saveProject(event)">
        <div class="form-group"><label>Project Name</label><input type="text" id="projectName" required placeholder="e.g., Jupiter Valve, Aortic X"></div>
        <button type="submit">Save Project</button>
        <button type="button" class="btn-secondary" onclick="closeProjectModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Sub Project Modal -->
  <div id="subProjectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="subProjectModalTitle">Add Sub Project</h2>
        <span class="close" onclick="closeSubProjectModal()">√ó</span>
      </div>
      <form onsubmit="saveSubProject(event)">
        <div class="form-group"><label>Code</label><input type="text" id="subProjectCode" required placeholder="e.g., N01"></div>
        <div class="form-group"><label>Sub Project Name</label><input type="text" id="subProjectName" required placeholder="e.g., Raw materials -Jupiter"></div>
        <button type="submit">Save Sub Project</button>
        <button type="button" class="btn-secondary" onclick="closeSubProjectModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // ============================
    // üîí SOFT SECURITY (HIDE MODE)
    // ============================

    const ADMIN_TABS = new Set(['tasks','budget','data']);
    const UNLOCK_KEY = 'eiic_unlocked';
    const PASS_KEY   = 'eiic_admin_password';

    // üîë CHANGE THIS:
    const DEFAULT_ADMIN_PASSWORD = "SSH";

    function getAdminPassword() {
      return (localStorage.getItem(PASS_KEY) || DEFAULT_ADMIN_PASSWORD).trim();
    }
    function setAdminPassword(pw) {
      const v = (pw || '').trim();
      if (!v) return;
      localStorage.setItem(PASS_KEY, v);
    }
    function isUnlocked() {
      return sessionStorage.getItem(UNLOCK_KEY) === '1';
    }
    function setUnlocked(val) {
      if (val) sessionStorage.setItem(UNLOCK_KEY, '1');
      else sessionStorage.removeItem(UNLOCK_KEY);
    }

    function hideAdminTabs() {
      document.querySelectorAll('.tab').forEach(btn => {
        const oc = btn.getAttribute('onclick') || '';
        for (const t of ADMIN_TABS) {
          if (oc.includes(`'${t}'`)) btn.style.display = 'none';
        }
      });
    }
    function showAdminTabs() {
      document.querySelectorAll('.tab').forEach(btn => btn.style.display = '');
    }

    function adminUnlock() {
      if (isUnlocked()) { showAdminTabs(); setStatus('üîì Admin tabs visible', '#ffffff'); return; }
      const entered = prompt('Enter admin code');
      if (entered === null) return;
      if (entered.trim() === getAdminPassword()) {
        setUnlocked(true);
        showAdminTabs();
        setStatus('üîì Admin unlocked (this session)', '#ffffff');
      } else {
        alert('Wrong password ‚ùå');
      }
    }

    function lockAdmin() {
      setUnlocked(false);
      hideAdminTabs();
      const active = document.querySelector('.tab-content.active')?.id;
      if (active && ADMIN_TABS.has(active)) switchTab('menu', null);
      setStatus('üîí Admin locked', '#ffffff');
    }

    // ============================
    // App data (defaults)
    // ============================

    let menuTasks = [
      {id: 1, systemName: 'Jupiter', owner: 'Tom Assaf', dueDate: '', task: 'Design and build a lower SC valve and define Pro-Cons', priority: 'Mid', status: 'Not Assigned', statusUpdate: '', notes: '', deliverables: ''},
      {id: 2, systemName: 'Jupiter', owner: 'Tom Assaf', dueDate: '', task: 'Design and build a SC that can collaps in VinV and define Pro-Cons', priority: 'Low-Mid', status: 'Not Assigned', statusUpdate: '', notes: '', deliverables: ''},
      {id: 3, systemName: 'Aortic-X: MIS', owner: 'Hadas Hoshen', dueDate: '2026-02-12', task: 'Create Concepts and list uses for IR on Aortic monitoring implant for AT', priority: 'Low', status: 'Assigned', statusUpdate: '', notes: 'I sent to haim for quick evaluetion.', deliverables: ''},
      {id: 7, systemName: 'Jupiter', owner: 'Tom Assaf', dueDate: '2026-02-05', task: 'Define and build of an Expansion test', priority: 'High', status: 'Ongoing', statusUpdate: 'Delayed', notes: 'Behind schedule', deliverables: ''},
      {id: 8, systemName: 'Jupiter', owner: 'Gal Aviram', dueDate: '2026-02-20', task: 'Finish Apex to annulus testing', priority: 'High', status: 'Assigned', statusUpdate: '', notes: '', deliverables: ''},
    ];

    let orders = [
      {id: 1, date: '2026-01-22', project: 'Test setups and Fixtures - Jupiter', vendor: 'Mailya', currency: 'ILS', cost: 725, usd: 223.08, status: 'Received', quarter: 'Q1'},
      {id: 2, date: '2026-01-22', project: 'supply and miscellaneous and consulters', vendor: '◊ê◊ï◊ú◊ò◊®◊î ◊î◊©◊ó◊ñ◊ï◊™', currency: 'ILS', cost: 500, usd: 153.85, status: 'PO Sent', quarter: 'Q1'}
    ];

    let flights = [
      {id: 1, startDate: '2026-01-24', endDate: '2026-01-26', destination: 'Los Angeles - STS', travelers: 'Haim, Gal, Amir, Shiri', cost: 9000, status: 'Complete'},
      {id: 2, startDate: '2026-03-15', endDate: '2026-03-18', destination: 'RI prep + residual force test', travelers: 'Amir, Tom', cost: 6000, status: 'Ordered'},
      {id: 3, startDate: '2026-05-02', endDate: '2026-05-05', destination: 'Seattle - AATS', travelers: 'Haim', cost: 0, status: 'Planned'}
    ];

    let budgetItems = [
      {code:'N01', name:'Raw materials -Jupiter', q1_aop:2000, q1_act:0, q2_aop:5000, q2_act:0, q3_aop:0, q3_act:0, q4_aop:0, q4_act:0, total_aop:7000, total_act:0},
      {code:'N04', name:'Test setups and Fixtures - Jupiter', q1_aop:3000, q1_act:223.08, q2_aop:6000, q2_act:0, q3_aop:0, q3_act:0, q4_aop:0, q4_act:0, total_aop:9000, total_act:223.08},
      {code:'N09', name:'supply and miscellaneous and consulters', q1_aop:2000, q1_act:153.85, q2_aop:2000, q2_act:0, q3_aop:0, q3_act:0, q4_aop:0, q4_act:0, total_aop:4000, total_act:153.85},
    ];

    let teamMembers = [
      {id:1, name:'Tom Assaf', email:'tom_assaf@edwards.com'},
      {id:2, name:'Gal Aviram', email:'gal_aviram@edwards.com'},
      {id:3, name:'Hadas Hoshen', email:'hadas_hoshencohen@edwards.com'},
      {id:4, name:'Haim', email:'haim_brauon@edwards.com'},
      {id:5, name:'Amir', email:'amir@edwards.com'},
      {id:6, name:'Nofar', email:'nofar@edwards.com'},
      {id:7, name:'Shiri', email:'shiri@edwards.com'},
      {id:8, name:'Tal', email:'tal@edwards.com'}
    ];

    let projectNames = [
      'Ideation','General','Aortic-X: MIS','Jupiter','Aortic-X: Valve improvements','Aortic-X: Valve in Valve'
    ];

    // ============================
    // Helpers
    // ============================

    function setStatus(msg, color) {
      const s = document.getElementById('syncStatus');
      if (!s) return;
      s.textContent = msg || '';
      if (color) s.style.color = color;
    }

    function switchTab(tabName, event) {
      // If somehow called on protected tab while locked (e.g., devtools), block it.
      if (ADMIN_TABS.has(tabName) && !isUnlocked()) return;

      const clickedButton = event ? event.target : document.querySelector(`.tab[onclick*="${tabName}"]`);
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      if (clickedButton) clickedButton.classList.add('active');
      const tabContent = document.getElementById(tabName);
      if (tabContent) tabContent.classList.add('active');
    }

    function getExchangeRates() {
      return {
        ILS: parseFloat(document.getElementById('ilsToUsdRate')?.value) || 3.25,
        USD: 1,
        EUR: parseFloat(document.getElementById('eurToUsdRate')?.value) || 0.92
      };
    }

    function formatCurrency(amount, currency='USD') {
      const symbols = {USD:'$', ILS:'‚Ç™', EUR:'‚Ç¨'};
      const v = Number(amount || 0);
      return `${symbols[currency]}${v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
    }

    function convertToUSD(amount, fromCurrency) {
      const rates = getExchangeRates();
      return Number(amount || 0) / (rates[fromCurrency] || 1);
    }

    function getQuarter(dateString) {
      if (!dateString) return '';
      const d = new Date(dateString);
      const m = d.getMonth() + 1;
      if (m <= 3) return 'Q1';
      if (m <= 6) return 'Q2';
      if (m <= 9) return 'Q3';
      return 'Q4';
    }

    function isOverdue(dueDate) {
      if (!dueDate) return false;
      const today = new Date(); today.setHours(0,0,0,0);
      const due = new Date(dueDate); due.setHours(0,0,0,0);
      return due < today;
    }

    // ============================
    // Menu tasks
    // ============================

    function loadMenuTasks() {
      const owners = [...new Set(menuTasks.map(t => t.owner))];
      const ownerFilter = document.getElementById('menuOwnerFilter');
      const current = ownerFilter.value;
      ownerFilter.innerHTML = '<option value="">All Owners</option>' +
        owners.map(o => `<option value="${o}" ${o===current?'selected':''}>${o}</option>`).join('');
      filterMenuTasks();
      updateEmailRecipientDropdown();
    }

    function filterMenuTasks() {
      const owner = document.getElementById('menuOwnerFilter').value;
      const filtered = menuTasks.filter(t => {
        const matchesOwner = !owner || t.owner === owner;
        const showOnly = (t.status === 'Assigned' || t.status === 'Ongoing');
        return matchesOwner && showOnly;
      });

      const tbody = document.getElementById('menuTableBody');
      tbody.innerHTML = filtered.map(task => {
        const overdue = isOverdue(task.dueDate);
        let rowClass = overdue ? 'overdue' : '';
        if (task.statusUpdate === 'Done') rowClass = 'menu-done';

        const due = task.dueDate || 'Not Set';
        const su = task.statusUpdate || '-';
        const notes = task.notes || '-';
        const del = task.deliverables
          ? `<a href="${task.deliverables}" target="_blank" rel="noopener noreferrer">üîó Link</a>`
          : '-';

        return `
          <tr class="${rowClass}">
            <td>${task.id}</td>
            <td>${task.systemName}</td>
            <td>${task.task}</td>
            <td>${task.owner}</td>
            <td>${due}${overdue ? ' <span class="flag overdue">OVERDUE</span>' : ''}</td>
            <td>${task.priority}</td>
            <td><span class="status ${task.status.toLowerCase().replace(' ','-')}">${task.status}</span></td>
            <td><span class="status ${String(su).toLowerCase()}">${su}</span></td>
            <td>${notes}</td>
            <td>${del}</td>
            <td><button class="btn-small btn-flag" type="button" onclick="updateTaskStatus(${task.id})">Update</button></td>
          </tr>
        `;
      }).join('');
    }

    // Task Update Modal
    let updatingTaskId = null;

    function updateTaskStatus(id) {
      updatingTaskId = id;
      const task = menuTasks.find(t => t.id === id);
      document.getElementById('taskUpdateStatus').value = task.statusUpdate || '';
      document.getElementById('taskUpdateDeliverables').value = task.deliverables || '';
      document.getElementById('taskUpdateNotes').value = task.notes || '';
      document.getElementById('taskUpdateModal').classList.add('active');
    }

    function closeTaskUpdateModal() {
      document.getElementById('taskUpdateModal').classList.remove('active');
      document.querySelector('#taskUpdateModal form').reset();
      updatingTaskId = null;
    }

    function saveTaskUpdate(event) {
      event.preventDefault();
      const task = menuTasks.find(t => t.id === updatingTaskId);
      task.statusUpdate = document.getElementById('taskUpdateStatus').value;
      task.deliverables = document.getElementById('taskUpdateDeliverables').value;
      const newNotes = document.getElementById('taskUpdateNotes').value;
      if (newNotes) task.notes = newNotes;

      closeTaskUpdateModal();
      refreshUI();
      autoSave();
      alert('Task status updated!');
    }

    // ============================
    // Tasks Bank CRUD + inline
    // ============================

    function updateProjectDropdowns() {
      const sel = document.getElementById('taskProjectName');
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = '<option value="">Select Project...</option>' +
        projectNames.map(n => `<option value="${n}" ${n===current?'selected':''}>${n}</option>`).join('');
    }

    function updateOwnerDropdowns() {
      const sel = document.getElementById('taskOwner');
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = teamMembers.map(m => `<option value="${m.name}" ${m.name===current?'selected':''}>${m.name}</option>`).join('');
      updateEmailRecipientDropdown();
    }

    function loadAllTasks() {
      document.getElementById('taskCount').textContent = menuTasks.length;

      const owners = [...new Set(menuTasks.map(t => t.owner))];
      const ownerFilter = document.getElementById('taskOwnerFilter');
      const current = ownerFilter.value;
      ownerFilter.innerHTML = '<option value="">All Owners</option>' +
        owners.map(o => `<option value="${o}" ${o===current?'selected':''}>${o}</option>`).join('');

      filterTasks();
    }

    function filterTasks() {
      const search = document.getElementById('taskSearch').value.toLowerCase();
      const owner = document.getElementById('taskOwnerFilter').value;
      const status = document.getElementById('taskStatusFilter').value;

      const filtered = menuTasks.filter(t => {
        const matchesSearch = t.task.toLowerCase().includes(search) || t.owner.toLowerCase().includes(search);
        const matchesOwner = !owner || t.owner === owner;
        const matchesStatus = !status || t.status === status;
        return matchesSearch && matchesOwner && matchesStatus;
      });

      const tbody = document.getElementById('taskTableBody');
      tbody.innerHTML = filtered.map(t => {
        const overdue = isOverdue(t.dueDate);
        let rowClass = '';
        if (t.status === 'Done') rowClass = 'done';
        else if (t.statusUpdate === 'Done') rowClass = 'menu-done';
        else if (overdue) rowClass = 'overdue';

        const due = t.dueDate || 'Not Set';
        const menuStatus = t.statusUpdate ? `<span class="status ${t.statusUpdate.toLowerCase()}">${t.statusUpdate}</span>` : '-';
        const del = t.deliverables ? `<a href="${t.deliverables}" target="_blank" rel="noopener noreferrer">üîó Link</a>` : '-';

        return `
          <tr class="${rowClass}">
            <td>${t.id}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'systemName',${t.id})">${t.systemName}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'owner',${t.id})">${t.owner}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'dueDate',${t.id})">${due}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'task',${t.id})">${t.task}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'priority',${t.id})">${t.priority}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'status',${t.id})"><span class="status ${t.status.toLowerCase().replace(' ','-')}">${t.status}</span></td>
            <td>${menuStatus}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'notes',${t.id})">${t.notes || '-'}</td>
            <td class="editable-cell" onclick="editTaskCell(this,'deliverables',${t.id})">${t.deliverables || '-'}</td>
            <td>
              <button class="btn-small btn-edit" type="button" onclick="editTaskFull(${t.id})">Edit</button>
              <button class="btn-small btn-danger" type="button" onclick="deleteTask(${t.id})">Del</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function editTaskCell(cell, field, taskId) {
      const task = menuTasks.find(t => t.id === taskId);
      if (!task) return;

      const currentText = cell.textContent.trim();
      const currentValue = (currentText === '-' ? '' : currentText);

      if (field === 'systemName') {
        const select = document.createElement('select');
        select.innerHTML = '<option value="">Select Project...</option>' +
          projectNames.map(n => `<option value="${n}" ${n===task.systemName?'selected':''}>${n}</option>`).join('');
        select.onblur = () => { task.systemName = select.value; refreshUI(); autoSave(); };
        select.onchange = () => select.blur();
        cell.textContent = ''; cell.appendChild(select); select.focus();
        return;
      }

      if (field === 'owner') {
        const select = document.createElement('select');
        const owners = teamMembers.map(m => m.name);
        select.innerHTML = owners.map(o => `<option value="${o}" ${o===task.owner?'selected':''}>${o}</option>`).join('');
        select.onblur = () => { task.owner = select.value; refreshUI(); autoSave(); };
        select.onchange = () => select.blur();
        cell.textContent = ''; cell.appendChild(select); select.focus();
        return;
      }

      if (field === 'priority') {
        const select = document.createElement('select');
        const priorities = ['High','Mid-High','Mid','Low-Mid','Low'];
        select.innerHTML = priorities.map(p => `<option value="${p}" ${p===task.priority?'selected':''}>${p}</option>`).join('');
        select.onblur = () => { task.priority = select.value; refreshUI(); autoSave(); };
        select.onchange = () => select.blur();
        cell.textContent = ''; cell.appendChild(select); select.focus();
        return;
      }

      if (field === 'status') {
        const select = document.createElement('select');
        const statuses = ['Not Assigned','Assigned','Done','Delayed','Ongoing'];
        select.innerHTML = statuses.map(s => `<option value="${s}" ${s===task.status?'selected':''}>${s}</option>`).join('');
        select.onblur = () => { task.status = select.value; refreshUI(); autoSave(); };
        select.onchange = () => select.blur();
        cell.textContent = ''; cell.appendChild(select); select.focus();
        return;
      }

      if (field === 'dueDate') {
        const input = document.createElement('input');
        input.type = 'date';
        input.value = task.dueDate || '';
        input.onblur = () => { task.dueDate = input.value; refreshUI(); autoSave(); };
        cell.textContent = ''; cell.appendChild(input); input.focus();
        return;
      }

      const input = document.createElement('input');
      input.type = 'text';
      input.value = (field === 'deliverables' ? task.deliverables || '' : currentValue);
      input.style.width = '100%';
      input.onblur = () => { task[field] = input.value; refreshUI(); autoSave(); };
      input.onkeypress = (e) => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } };
      cell.textContent = ''; cell.appendChild(input); input.focus(); input.select();
    }

    let editingTaskId = null;

    function openTaskModal() {
      editingTaskId = null;
      document.getElementById('taskModalTitle').textContent = 'Add New Task';
      updateProjectDropdowns();
      updateOwnerDropdowns();
      document.getElementById('taskModal').classList.add('active');
    }

    function closeTaskModal() {
      document.getElementById('taskModal').classList.remove('active');
      document.querySelector('#taskModal form').reset();
      editingTaskId = null;
    }

    function editTaskFull(id) {
      editingTaskId = id;
      const t = menuTasks.find(x => x.id === id);
      document.getElementById('taskModalTitle').textContent = 'Edit Task';
      updateProjectDropdowns();
      updateOwnerDropdowns();
      document.getElementById('taskProjectName').value = t.systemName || '';
      document.getElementById('taskOwner').value = t.owner;
      document.getElementById('taskDueDate').value = t.dueDate || '';
      document.getElementById('taskDescription').value = t.task;
      document.getElementById('taskPriority').value = t.priority;
      document.getElementById('taskStatus').value = t.status;
      document.getElementById('taskNotes').value = t.notes || '';
      document.getElementById('taskDeliverables').value = t.deliverables || '';
      document.getElementById('taskModal').classList.add('active');
    }

    function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      const idx = menuTasks.findIndex(t => t.id === id);
      if (idx > -1) menuTasks.splice(idx, 1);
      refreshUI();
      autoSave();
      alert('Task deleted!');
    }

    function saveTask(event) {
      event.preventDefault();
      const data = {
        systemName: document.getElementById('taskProjectName').value,
        owner: document.getElementById('taskOwner').value,
        dueDate: document.getElementById('taskDueDate').value,
        task: document.getElementById('taskDescription').value,
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        notes: document.getElementById('taskNotes').value,
        deliverables: document.getElementById('taskDeliverables').value,
        statusUpdate: ''
      };
      if (editingTaskId) {
        Object.assign(menuTasks.find(t => t.id === editingTaskId), data);
        alert('Task updated!');
      } else {
        const newId = Math.max(...menuTasks.map(t => t.id), 0) + 1;
        menuTasks.push({id:newId, ...data});
        alert('Task added!');
      }
      closeTaskModal();
      refreshUI();
      autoSave();
    }

    // ============================
    // Orders
    // ============================

    let editingOrderId = null;

    function loadOrders() {
      const names = [...new Set(budgetItems.map(b => b.name))];
      const sel = document.getElementById('orderProject');
      sel.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join('');

      const tbody = document.getElementById('ordersTableBody');
      tbody.innerHTML = orders.map(o => `
        <tr>
          <td>${o.date}</td>
          <td>${o.project}</td>
          <td>${o.vendor}</td>
          <td>${formatCurrency(o.usd,'USD')} (${o.cost} ${o.currency})</td>
          <td><span class="status ${o.status.toLowerCase().replace(' ','-')}">${o.status}</span></td>
          <td>
            <button class="btn-small btn-edit" type="button" onclick="editOrder(${o.id})">Edit</button>
            <button class="btn-small btn-danger" type="button" onclick="deleteOrder(${o.id})">Del</button>
          </td>
        </tr>
      `).join('');
    }

    function openOrderModal() {
      editingOrderId = null;
      document.getElementById('orderModalTitle').textContent = 'Add New Order';
      document.getElementById('orderCurrency').value = 'ILS';
      updateCurrencyLabel();
      document.getElementById('orderModal').classList.add('active');
    }

    function closeOrderModal() {
      document.getElementById('orderModal').classList.remove('active');
      document.querySelector('#orderModal form').reset();
      editingOrderId = null;
    }

    function updateCurrencyLabel() {
      const c = document.getElementById('orderCurrency').value;
      document.getElementById('currencyLabel').textContent = c;
      showUSDConversion();
    }

    function showUSDConversion() {
      const cost = parseFloat(document.getElementById('orderCost').value) || 0;
      const currency = document.getElementById('orderCurrency').value;
      const div = document.getElementById('usdConversion');
      const rates = getExchangeRates();
      if (cost > 0 && currency !== 'USD') {
        const usd = convertToUSD(cost, currency);
        div.textContent = `‚âà ${formatCurrency(usd,'USD')} (Rate: 1 USD = ${rates[currency]} ${currency})`;
      } else {
        div.textContent = '';
      }
    }

    function editOrder(id) {
      editingOrderId = id;
      const o = orders.find(x => x.id === id);
      document.getElementById('orderModalTitle').textContent = 'Edit Order';
      document.getElementById('orderDate').value = o.date;
      document.getElementById('orderProject').value = o.project;
      document.getElementById('orderVendor').value = o.vendor;
      document.getElementById('orderCurrency').value = o.currency;
      document.getElementById('orderCost').value = o.cost;
      document.getElementById('orderStatus').value = o.status;
      updateCurrencyLabel();
      document.getElementById('orderModal').classList.add('active');
    }

    function deleteOrder(id) {
      if (!confirm('Delete this order?')) return;
      const idx = orders.findIndex(o => o.id === id);
      if (idx > -1) orders.splice(idx, 1);
      refreshUI();
      autoSave();
      alert('Order deleted!');
    }

    function saveOrder(event) {
      event.preventDefault();
      const data = {
        date: document.getElementById('orderDate').value,
        project: document.getElementById('orderProject').value,
        vendor: document.getElementById('orderVendor').value,
        currency: document.getElementById('orderCurrency').value,
        cost: parseFloat(document.getElementById('orderCost').value),
        status: document.getElementById('orderStatus').value
      };
      data.usd = convertToUSD(data.cost, data.currency);
      data.quarter = getQuarter(data.date);

      if (editingOrderId) {
        Object.assign(orders.find(o => o.id === editingOrderId), data);
        alert('Order updated!');
      } else {
        const newId = Math.max(...orders.map(o => o.id), 0) + 1;
        orders.push({id:newId, ...data});
        alert(`Order added!\nUSD: ${formatCurrency(data.usd,'USD')}`);
      }
      closeOrderModal();
      refreshUI();
      autoSave();
    }

    // ============================
    // Flights
    // ============================

    let editingFlightId = null;

    function loadFlights() {
      const tbody = document.getElementById('flightsTableBody');
      tbody.innerHTML = flights.map(f => {
        const displayCost = (f.cost > 0) ? formatCurrency(f.cost,'USD') : 'TBD';
        return `
          <tr>
            <td>${f.startDate} to ${f.endDate}</td>
            <td>${f.destination}</td>
            <td>${f.travelers}</td>
            <td>${displayCost}</td>
            <td><span class="status ${f.status.toLowerCase()}">${f.status}</span></td>
            <td>
              <button class="btn-small btn-edit" type="button" onclick="editFlight(${f.id})">Edit</button>
              <button class="btn-small btn-danger" type="button" onclick="deleteFlight(${f.id})">Del</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function openFlightModal() {
      editingFlightId = null;
      document.getElementById('flightModalTitle').textContent = 'Add New Flight';
      document.getElementById('flightModal').classList.add('active');
    }

    function closeFlightModal() {
      document.getElementById('flightModal').classList.remove('active');
      document.querySelector('#flightModal form').reset();
      editingFlightId = null;
    }

    function editFlight(id) {
      editingFlightId = id;
      const f = flights.find(x => x.id === id);
      document.getElementById('flightModalTitle').textContent = 'Edit Flight';
      document.getElementById('flightStartDate').value = f.startDate;
      document.getElementById('flightEndDate').value = f.endDate;
      document.getElementById('flightDestination').value = f.destination;

      const travelers = (f.travelers || '').split(', ').filter(Boolean);
      const sel = document.getElementById('flightTravelers');
      for (const opt of sel.options) opt.selected = travelers.includes(opt.value);

      document.getElementById('flightCost').value = f.cost || '';
      document.getElementById('flightStatus').value = f.status;
      document.getElementById('flightModal').classList.add('active');
    }

    function deleteFlight(id) {
      if (!confirm('Delete this flight?')) return;
      const idx = flights.findIndex(f => f.id === id);
      if (idx > -1) flights.splice(idx, 1);
      refreshUI();
      autoSave();
      alert('Flight deleted!');
    }

    function saveFlight(event) {
      event.preventDefault();
      const sel = document.getElementById('flightTravelers');
      const selected = Array.from(sel.selectedOptions).map(o => o.value);
      const data = {
        startDate: document.getElementById('flightStartDate').value,
        endDate: document.getElementById('flightEndDate').value,
        destination: document.getElementById('flightDestination').value,
        travelers: selected.join(', '),
        cost: parseFloat(document.getElementById('flightCost').value) || 0,
        status: document.getElementById('flightStatus').value
      };

      if (editingFlightId) {
        Object.assign(flights.find(f => f.id === editingFlightId), data);
        alert('Flight updated!');
      } else {
        const newId = Math.max(...flights.map(f => f.id), 0) + 1;
        flights.push({id:newId, ...data});
        alert('Flight added!');
      }
      closeFlightModal();
      refreshUI();
      autoSave();
    }

    // ============================
    // Budget
    // ============================

    function recalculateBudget() {
      budgetItems.forEach(i => { i.q1_act=0; i.q2_act=0; i.q3_act=0; i.q4_act=0; i.total_act=0; });

      orders.forEach(o => {
        if (o.status !== 'PO Sent' && o.status !== 'Received') return;
        const item = budgetItems.find(b => b.name === o.project);
        if (!item) return;
        if (o.quarter === 'Q1') item.q1_act += o.usd;
        if (o.quarter === 'Q2') item.q2_act += o.usd;
        if (o.quarter === 'Q3') item.q3_act += o.usd;
        if (o.quarter === 'Q4') item.q4_act += o.usd;
        item.total_act = item.q1_act + item.q2_act + item.q3_act + item.q4_act;
      });
    }

    function loadBudget() {
      const tbody = document.getElementById('budgetTableBody');
      tbody.innerHTML = budgetItems.map(it => `
        <tr>
          <td>${it.code}</td>
          <td>${it.name}</td>
          <td class="editable-cell" onclick="editBudgetCell(this,'q1_aop','${it.code}')">${it.q1_aop||0}</td>
          <td>${Number(it.q1_act||0).toFixed(2)}</td>
          <td class="editable-cell" onclick="editBudgetCell(this,'q2_aop','${it.code}')">${it.q2_aop||0}</td>
          <td>${Number(it.q2_act||0).toFixed(2)}</td>
          <td class="editable-cell" onclick="editBudgetCell(this,'q3_aop','${it.code}')">${it.q3_aop||0}</td>
          <td>${Number(it.q3_act||0).toFixed(2)}</td>
          <td class="editable-cell" onclick="editBudgetCell(this,'q4_aop','${it.code}')">${it.q4_aop||0}</td>
          <td>${Number(it.q4_act||0).toFixed(2)}</td>
          <td><strong>${it.total_aop||0}</strong></td>
          <td><strong>${Number(it.total_act||0).toFixed(2)}</strong></td>
        </tr>
      `).join('');
    }

    function editBudgetCell(cell, field, code) {
      const currentValue = cell.textContent.trim();
      const input = document.createElement('input');
      input.type = 'number';
      input.value = currentValue;
      input.style.width = '100%';
      input.onblur = () => {
        const item = budgetItems.find(b => b.code === code);
        if (item) {
          item[field] = parseFloat(input.value) || 0;
          item.total_aop = (item.q1_aop||0)+(item.q2_aop||0)+(item.q3_aop||0)+(item.q4_aop||0);
        }
        refreshUI();
        autoSave();
      };
      input.onkeypress = (e) => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } };
      cell.textContent = ''; cell.appendChild(input); input.focus(); input.select();
    }

    function validateBudget() {
      const totalBudget = parseFloat(document.getElementById('totalBudgetInput').value) || 60000;
      const flightBudget = parseFloat(document.getElementById('flightBudgetAllocation').value) || 20000;
      const operationalBudget = totalBudget - flightBudget;

      const totalAOP = budgetItems.reduce((sum, it) => sum + (it.total_aop || 0), 0);
      const div = document.getElementById('budgetValidation');

      if (Math.abs(totalAOP - operationalBudget) < 0.01) {
        div.innerHTML = '<div class="validation-success">‚úì Budget is balanced! Total AOP matches Operational Budget.</div>';
      } else {
        const diff = totalAOP - operationalBudget;
        const msg = diff > 0
          ? `‚ö†Ô∏è Budget over-allocated by ${formatCurrency(Math.abs(diff),'USD')}`
          : `‚ö†Ô∏è Budget under-allocated by ${formatCurrency(Math.abs(diff),'USD')}`;
        div.innerHTML = `<div class="validation-error">${msg}</div>`;
      }
    }

    function calculateQuarterlyPredictions() {
      const predictions = [];
      const quarters = ['Q1','Q2','Q3','Q4'];
      const today = new Date();
      const currentQuarter = Math.ceil((today.getMonth()+1)/3);
      let carryOver = 0;

      quarters.forEach((q, idx) => {
        const qNum = idx + 1;
        const totalAOP = budgetItems.reduce((sum,it) => sum + (it[`q${qNum}_aop`] || 0), 0);
        const totalACT = budgetItems.reduce((sum,it) => sum + (it[`q${qNum}_act`] || 0), 0);

        const adjustedBudget = totalAOP + carryOver;
        const variance = adjustedBudget - totalACT;
        const pctVar = adjustedBudget > 0 ? variance / adjustedBudget : 0;

        let prediction = 'Planned';
        let cls = 'future';
        let remaining = adjustedBudget;

        if (qNum <= currentQuarter) {
          remaining = variance;
          if (Math.abs(pctVar) <= 0.15) { prediction = 'On Budget'; cls='on-budget'; }
          else if (variance < 0) { prediction = `Over (${(Math.abs(pctVar)*100).toFixed(0)}%)`; cls='overspending'; }
          else { prediction = `Under (${(Math.abs(pctVar)*100).toFixed(0)}%)`; cls='underspending'; }
          if (qNum < currentQuarter) carryOver += variance;
        }

        predictions.push({quarter:q, prediction, cls, remaining, totalAOP, totalACT});
      });

      const container = document.getElementById('quarterlyPredictions');
      container.innerHTML = predictions.map(p => {
        const remainingColor = p.remaining >= 0 ? '#28a745' : '#dc3545';
        return `
          <div class="quarter-card">
            <h4>${p.quarter}</h4>
            <div class="prediction ${p.cls}">${p.prediction}</div>
            <div style="margin-top:8px;font-size:12px;color:#666;">
              <div>Budget: ${formatCurrency(p.totalAOP,'USD')}</div>
              <div>Spent: ${formatCurrency(p.totalACT,'USD')}</div>
              <div style="font-weight:bold;color:${remainingColor};margin-top:5px;">
                Remaining: ${formatCurrency(p.remaining,'USD')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateBudgetSummary() {
      const totalBudget = parseFloat(document.getElementById('totalBudgetInput').value) || 60000;
      const flightAllocation = parseFloat(document.getElementById('flightBudgetAllocation').value) || 20000;
      const operationalBudget = totalBudget - flightAllocation;

      let spentFromPOs = 0;
      orders.forEach(o => { if (o.status==='PO Sent' || o.status==='Received') spentFromPOs += o.usd; });

      let spentFromFlights = 0;
      flights.forEach(f => { if ((f.status==='Ordered' || f.status==='Complete') && f.cost>0) spentFromFlights += f.cost; });

      const subtotalSpent = spentFromPOs + spentFromFlights;
      const totalRemaining = totalBudget - subtotalSpent;
      const operationalRemaining = operationalBudget - spentFromPOs;
      const flightRemaining = flightAllocation - spentFromFlights;

      document.getElementById('operationalBudget').textContent = formatCurrency(operationalBudget,'USD');
      document.getElementById('operationalBudget2').textContent = formatCurrency(operationalBudget,'USD');
      document.getElementById('spentFromPOs').textContent = formatCurrency(spentFromPOs,'USD');
      document.getElementById('spentFromFlights').textContent = formatCurrency(spentFromFlights,'USD');
      document.getElementById('subtotalSpent').textContent = formatCurrency(subtotalSpent,'USD');
      document.getElementById('totalRemaining').textContent = formatCurrency(totalRemaining,'USD');
      document.getElementById('operationalRemaining').textContent = formatCurrency(operationalRemaining,'USD');
      document.getElementById('flightRemaining').textContent = formatCurrency(flightRemaining,'USD');

      validateBudget();
      calculateQuarterlyPredictions();
    }

    // ============================
    // Data tab tables
    // ============================

    function loadTeamMembers() {
      const tbody = document.getElementById('teamMembersTableBody');
      tbody.innerHTML = teamMembers.map(m => `
        <tr>
          <td class="editable-cell" onclick="editTeamMemberCell(this,'name',${m.id})">${m.name}</td>
          <td class="editable-cell" onclick="editTeamMemberCell(this,'email',${m.id})">${m.email}</td>
          <td>
            <button class="btn-small btn-edit" type="button" onclick="editTeamMemberFull(${m.id})">Edit</button>
            <button class="btn-small btn-danger" type="button" onclick="deleteTeamMember(${m.id})">Del</button>
          </td>
        </tr>
      `).join('');
    }

    function editTeamMemberCell(cell, field, id) {
      const m = teamMembers.find(x => x.id === id);
      if (!m) return;
      const input = document.createElement('input');
      input.type = field === 'email' ? 'email' : 'text';
      input.value = cell.textContent.trim();
      input.style.width = '100%';
      input.onblur = () => { m[field] = input.value; refreshUI(); autoSave(); };
      input.onkeypress = (e) => { if (e.key==='Enter') { e.preventDefault(); input.blur(); } };
      cell.textContent=''; cell.appendChild(input); input.focus(); input.select();
    }

    let editingTeamMemberId = null;

    function openTeamMemberModal() {
      editingTeamMemberId = null;
      document.getElementById('teamMemberModalTitle').textContent = 'Add Team Member';
      document.getElementById('teamMemberModal').classList.add('active');
    }
    function closeTeamMemberModal() {
      document.getElementById('teamMemberModal').classList.remove('active');
      document.querySelector('#teamMemberModal form').reset();
      editingTeamMemberId = null;
    }
    function editTeamMemberFull(id) {
      editingTeamMemberId = id;
      const m = teamMembers.find(x => x.id === id);
      document.getElementById('teamMemberModalTitle').textContent = 'Edit Team Member';
      document.getElementById('teamMemberName').value = m.name;
      document.getElementById('teamMemberEmail').value = m.email;
      document.getElementById('teamMemberModal').classList.add('active');
    }
    function deleteTeamMember(id) {
      if (!confirm('Delete this team member?')) return;
      const idx = teamMembers.findIndex(m => m.id === id);
      if (idx > -1) teamMembers.splice(idx,1);
      refreshUI(); autoSave();
      alert('Team member deleted!');
    }
    function saveTeamMember(event) {
      event.preventDefault();
      const data = {
        name: document.getElementById('teamMemberName').value,
        email: document.getElementById('teamMemberEmail').value
      };
      if (editingTeamMemberId) {
        Object.assign(teamMembers.find(m => m.id === editingTeamMemberId), data);
        alert('Team member updated!');
      } else {
        const newId = Math.max(...teamMembers.map(m => m.id), 0) + 1;
        teamMembers.push({id:newId, ...data});
        alert('Team member added!');
      }
      closeTeamMemberModal();
      refreshUI(); autoSave();
    }

    function loadProjectNames() {
      const tbody = document.getElementById('projectNamesTableBody');
      tbody.innerHTML = projectNames.map((name, idx) => `
        <tr>
          <td class="editable-cell" onclick="editProjectNameCell(this,${idx})">${name}</td>
          <td>
            <button class="btn-small btn-edit" type="button" onclick="editProjectFull(${idx})">Edit</button>
            <button class="btn-small btn-danger" type="button" onclick="deleteProject(${idx})">Del</button>
          </td>
        </tr>
      `).join('');
    }

    function editProjectNameCell(cell, idx) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = cell.textContent.trim();
      input.style.width = '100%';
      input.onblur = () => {
        const old = projectNames[idx];
        const val = input.value;
        projectNames[idx] = val;
        menuTasks.forEach(t => { if (t.systemName === old) t.systemName = val; });
        refreshUI(); autoSave();
      };
      input.onkeypress = (e) => { if (e.key==='Enter') { e.preventDefault(); input.blur(); } };
      cell.textContent=''; cell.appendChild(input); input.focus(); input.select();
    }

    let editingProjectId = null;

    function openProjectModal() {
      editingProjectId = null;
      document.getElementById('projectModalTitle').textContent = 'Add Project';
      document.getElementById('projectModal').classList.add('active');
    }
    function closeProjectModal() {
      document.getElementById('projectModal').classList.remove('active');
      document.querySelector('#projectModal form').reset();
      editingProjectId = null;
    }
    function editProjectFull(idx) {
      editingProjectId = idx;
      document.getElementById('projectModalTitle').textContent = 'Edit Project';
      document.getElementById('projectName').value = projectNames[idx];
      document.getElementById('projectModal').classList.add('active');
    }
    function deleteProject(idx) {
      if (!confirm('Delete this project?')) return;
      projectNames.splice(idx, 1);
      refreshUI(); autoSave();
      alert('Project deleted!');
    }
    function saveProject(event) {
      event.preventDefault();
      const name = document.getElementById('projectName').value;
      if (editingProjectId !== null) {
        const old = projectNames[editingProjectId];
        projectNames[editingProjectId] = name;
        menuTasks.forEach(t => { if (t.systemName === old) t.systemName = name; });
        alert('Project updated!');
      } else {
        projectNames.push(name);
        alert('Project added!');
      }
      closeProjectModal();
      refreshUI(); autoSave();
    }

    function loadSubProjectNames() {
      const tbody = document.getElementById('subProjectNamesTableBody');
      tbody.innerHTML = budgetItems.map((it, idx) => `
        <tr>
          <td class="editable-cell" onclick="editSubProjectCell(this,'code',${idx})">${it.code}</td>
          <td class="editable-cell" onclick="editSubProjectCell(this,'name',${idx})">${it.name}</td>
          <td>
            <button class="btn-small btn-edit" type="button" onclick="editSubProjectFull(${idx})">Edit</button>
            <button class="btn-small btn-danger" type="button" onclick="deleteSubProject(${idx})">Del</button>
          </td>
        </tr>
      `).join('');
    }

    function editSubProjectCell(cell, field, idx) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = cell.textContent.trim();
      input.style.width = '100%';
      input.onblur = () => { budgetItems[idx][field] = input.value; refreshUI(); autoSave(); };
      input.onkeypress = (e) => { if (e.key==='Enter') { e.preventDefault(); input.blur(); } };
      cell.textContent=''; cell.appendChild(input); input.focus(); input.select();
    }

    let editingSubProjectId = null;

    function openSubProjectModal() {
      editingSubProjectId = null;
      document.getElementById('subProjectModalTitle').textContent = 'Add Sub Project';
      document.getElementById('subProjectModal').classList.add('active');
    }
    function closeSubProjectModal() {
      document.getElementById('subProjectModal').classList.remove('active');
      document.querySelector('#subProjectModal form').reset();
      editingSubProjectId = null;
    }
    function editSubProjectFull(idx) {
      editingSubProjectId = idx;
      const it = budgetItems[idx];
      document.getElementById('subProjectModalTitle').textContent = 'Edit Sub Project';
      document.getElementById('subProjectCode').value = it.code;
      document.getElementById('subProjectName').value = it.name;
      document.getElementById('subProjectModal').classList.add('active');
    }
    function deleteSubProject(idx) {
      if (!confirm('Delete this sub project? This will also remove it from the budget.')) return;
      budgetItems.splice(idx, 1);
      refreshUI(); autoSave();
      alert('Sub project deleted!');
    }
    function saveSubProject(event) {
      event.preventDefault();
      const code = document.getElementById('subProjectCode').value;
      const name = document.getElementById('subProjectName').value;

      if (editingSubProjectId !== null) {
        budgetItems[editingSubProjectId].code = code;
        budgetItems[editingSubProjectId].name = name;
        alert('Sub project updated!');
      } else {
        budgetItems.push({
          code, name,
          q1_aop:0,q1_act:0,q2_aop:0,q2_act:0,q3_aop:0,q3_act:0,q4_aop:0,q4_act:0,
          total_aop:0,total_act:0
        });
        alert('Sub project added!');
      }
      closeSubProjectModal();
      refreshUI(); autoSave();
    }

    // ============================
    // Email
    // ============================

    function updateEmailRecipientDropdown() {
      const select = document.getElementById('emailRecipientSelect');
      if (!select) return;
      const ownersWithTasks = new Set();
      menuTasks.filter(t => t.status === 'Assigned' || t.status === 'Ongoing').forEach(t => ownersWithTasks.add(t.owner));
      select.innerHTML = '<option value="">Select team member...</option>' +
        teamMembers.filter(m => ownersWithTasks.has(m.name))
          .map(m => `<option value="${m.name}">${m.name}</option>`).join('');
    }

    function generateEmailBody(tasks, recipientName) {
      const template = document.getElementById('emailTemplate').value;

      let htmlTable = `
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 800px; border: 2px solid #000000;">
<tr bgcolor="#667eea">
<td style="padding: 10px; border: 2px solid #000000; color: #ffffff; font-weight: bold;">Task</td>
<td style="padding: 10px; border: 2px solid #000000; color: #ffffff; font-weight: bold;">Project</td>
<td style="padding: 10px; border: 2px solid #000000; color: #ffffff; font-weight: bold;">Due Date</td>
<td style="padding: 10px; border: 2px solid #000000; color: #ffffff; font-weight: bold;">Priority</td>
<td style="padding: 10px; border: 2px solid #000000; color: #ffffff; font-weight: bold;">Status</td>
</tr>`;

      tasks.forEach((task, idx) => {
        const overdue = isOverdue(task.dueDate) ? ' [OVERDUE]' : '';
        const bg = idx % 2 === 0 ? '#ffffff' : '#f5f5f5';
        htmlTable += `
<tr bgcolor="${bg}">
<td style="padding: 8px; border: 1px solid #000000;">${task.task}${overdue}</td>
<td style="padding: 8px; border: 1px solid #000000;">${task.systemName || '-'}</td>
<td style="padding: 8px; border: 1px solid #000000;">${task.dueDate || 'Not Set'}</td>
<td style="padding: 8px; border: 1px solid #000000;">${task.priority}</td>
<td style="padding: 8px; border: 1px solid #000000;">${task.status}</td>
</tr>`;
      });

      htmlTable += `</table>`;

      return template.replace('{name}', recipientName).replace('{tasks}', htmlTable);
    }

    function sendAllEmails() {
      const subject = document.getElementById('emailSubject').value;
      const tasksByOwner = {};
      menuTasks.filter(t => t.status==='Assigned' || t.status==='Ongoing').forEach(t => {
        if (!tasksByOwner[t.owner]) tasksByOwner[t.owner] = [];
        tasksByOwner[t.owner].push(t);
      });

      const links = [];
      Object.keys(tasksByOwner).forEach(ownerName => {
        const member = teamMembers.find(m => m.name === ownerName);
        if (!member) return;
        const body = generateEmailBody(tasksByOwner[ownerName], member.name);
        const mailto = `mailto:${member.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        links.push({name: member.name, link: mailto});
      });

      if (!links.length) return alert('No assigned tasks found!');
      window.open(links[0].link);
      if (links.length > 1) alert(`Opening email for ${links[0].name}.\n\nTo send to others, use "Send to One Person" dropdown.`);
    }

    function sendEmailByOwner() {
      const select = document.getElementById('emailRecipientSelect');
      const name = select.value;
      if (!name) return alert('Please select a team member from the dropdown.');
      const member = teamMembers.find(m => m.name === name);
      if (!member) return alert('Team member not found!');

      const tasks = menuTasks.filter(t => (t.status==='Assigned' || t.status==='Ongoing') && t.owner === member.name);
      if (!tasks.length) return alert(`No assigned tasks for ${member.name}!`);

      const subject = document.getElementById('emailSubject').value;
      const body = generateEmailBody(tasks, member.name);
      const mailto = `mailto:${member.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailto);
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) event.target.classList.remove('active');
    };

    // ============================
    // Firebase sync
    // ============================

    let isSaving = false;
    let saveTimeout = null;

    function autoSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => firebaseSave(), 1500);
    }

    function refreshUI() {
      loadMenuTasks();
      loadAllTasks();
      loadOrders();
      loadFlights();
      recalculateBudget();
      loadBudget();
      updateBudgetSummary();
      loadTeamMembers();
      loadProjectNames();
      loadSubProjectNames();
      updateProjectDropdowns();
      updateOwnerDropdowns();
      updateEmailRecipientDropdown();
    }

    function applyData(d) {
      if (d.menuTasks || d.tasks) menuTasks = d.menuTasks || d.tasks;
      if (d.orders) orders = d.orders;
      if (d.flights) flights = d.flights;
      if (d.budgetItems) budgetItems = d.budgetItems;
      if (d.teamMembers) teamMembers = d.teamMembers;
      if (d.projectNames) projectNames = d.projectNames;

      const cfg = d.config || d.settings || {};
      setTimeout(() => {
        if (cfg.ilsToUsdRate) document.getElementById('ilsToUsdRate').value = cfg.ilsToUsdRate;
        if (cfg.eurToUsdRate) document.getElementById('eurToUsdRate').value = cfg.eurToUsdRate;
        if (cfg.totalBudget) document.getElementById('totalBudgetInput').value = cfg.totalBudget;
        if (cfg.flightBudget || cfg.flightAllocation) document.getElementById('flightBudgetAllocation').value = cfg.flightBudget || cfg.flightAllocation;
        if (cfg.emailSubject) document.getElementById('emailSubject').value = cfg.emailSubject;
        if (cfg.emailTemplate) document.getElementById('emailTemplate').value = cfg.emailTemplate;

        // Optional: if saved password exists in Firebase config, mirror it locally (still soft security)
        if (cfg.systemPassword) {
          const input = document.getElementById('systemPassword');
          if (input) input.value = cfg.systemPassword;
          setAdminPassword(cfg.systemPassword);
        }
      }, 50);
    }

    function firebaseSave() {
      if (!window._fbRef) return;
      isSaving = true;
      setStatus('üíæ Saving...', '#ffffff');

      const data = {
        menuTasks, orders, flights, budgetItems, teamMembers, projectNames,
        config: {
          ilsToUsdRate: document.getElementById('ilsToUsdRate')?.value || '3.25',
          eurToUsdRate: document.getElementById('eurToUsdRate')?.value || '0.92',
          totalBudget: document.getElementById('totalBudgetInput')?.value || '60000',
          flightBudget: document.getElementById('flightBudgetAllocation')?.value || '20000',
          emailSubject: document.getElementById('emailSubject')?.value || '',
          emailTemplate: document.getElementById('emailTemplate')?.value || '',
          systemPassword: document.getElementById('systemPassword')?.value || ''
        },
        lastUpdate: new Date().toISOString()
      };

      window._fbRef.set(data)
        .then(() => {
          setStatus('‚úÖ Saved!', '#ffffff');
          setTimeout(() => { setStatus('', '#ffffff'); isSaving = false; }, 1200);
        })
        .catch(err => {
          setStatus('‚ö†Ô∏è ' + err.message, '#ffffff');
          isSaving = false;
        });
    }

    // ============================
    // Firebase init + listeners
    // ============================

    firebase.initializeApp({
      apiKey: "AIzaSyAa4L0D7_sZcakJj59hV1kf804kuBiK750",
      authDomain: "eiic-ssh-project.firebaseapp.com",
      databaseURL: "https://eiic-ssh-project-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eiic-ssh-project",
      storageBucket: "eiic-ssh-project.firebasestorage.app",
      messagingSenderId: "863438772787",
      appId: "1:863438772787:web:efdd025c59bd95ef836146"
    });

    const SECRET = "eiic_ssh_2026_haim";
    const _db = firebase.database();
    window._fbRef = _db.ref('apps/' + SECRET + '/projectData');

    // ============================
    // Single clean init
    // ============================

    window.addEventListener('DOMContentLoaded', () => {
      // Hide admin tabs on load unless already unlocked in this session
      if (isUnlocked()) showAdminTabs();
      else hideAdminTabs();

      // Optional: Data tab password field updates local storage
      const pwInput = document.getElementById('systemPassword');
      if (pwInput) {
        pwInput.addEventListener('change', () => {
          setAdminPassword(pwInput.value);
          setStatus('üîë Admin password saved locally', '#ffffff');
          setTimeout(() => setStatus('', '#ffffff'), 1500);
        });
      }

      // Render default UI immediately
      refreshUI();
      setStatus('üîÑ Loading...', '#ffffff');

      // Load from Firebase and subscribe
      window._fbRef.once('value').then(snap => {
        if (snap.exists()) {
          applyData(snap.val());
          refreshUI();
          setStatus('‚úÖ Live sync active', '#ffffff');
          setTimeout(() => setStatus('', '#ffffff'), 1500);
        } else {
          setStatus('üî• Firebase connected - no data yet', '#ffffff');
          setTimeout(() => setStatus('', '#ffffff'), 1500);
        }

        let skip = true;
        window._fbRef.on('value', snap2 => {
          if (skip) { skip = false; return; }
          if (isSaving) return;
          if (!snap2.exists()) return;
          applyData(snap2.val());
          refreshUI();
          setStatus('üîÑ Updated from team', '#ffffff');
          setTimeout(() => setStatus('', '#ffffff'), 1200);
        });
      }).catch(err => setStatus('‚ö†Ô∏è ' + err.message, '#ffffff'));
    });
  </script>
</body>
</html>
``
